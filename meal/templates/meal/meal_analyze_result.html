{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/meal_analyze.css' %}">
<script src="{% static 'js/meal_anal_result.js' %}"></script>
<style>
    #result_image_box {
        position: relative;
        display: inline-block;
        z-index: 1;
    }

    .marker {
        position: absolute;
        background-color: red;
        color: white;
        padding: 5px;
        border-radius: 5px;
        font-size: 15px;
        opacity: 0.6;
    }

    .marker:hover {
        transition-duration: 0.5s;
        background-color: darkred;
        opacity: 1;
        z-index: 40;
    }
</style>
<aside id="analyze_box" class="display_flex">
    <div id="result_image_box">
        {% if meal_image %}
        <img src="{{ meal_image }}" alt="meal_image" id="meal_image" style="max-width: 500px; max-height: 500px;">
        {% endif %}
    </div>
    <!-- 예측한 식단 불러와 띄워주기 -->
    <div id="modify_result">
        <h2 id="result_message">식단 예측 결과입니다</h2>
        <p>결과가 다른가요? 음식 추가 버튼을 눌러<br>음식을 검색해보세요.</p>
        <form method="post" id="meal_result_form" action="">
            {% csrf_token %}
            {% if detect_results %}
                {% for key, values in detect_results.items %}
                <div class="input_container">
                    <input class="food-input" type="text" id="input_{{ key }}" name="{{ key }}" value="{{ key }}">
                    <button type="button" class="remove_input greenBtn" title="음식 입력창을 삭제합니다.">입력창 삭제</button>
                    <ul class="search-results" style="display: none;"></ul>
                </div>
                {% endfor %}
            {% else %}
                <p id="not_detected">이 음식의 종류를 알 수 없습니다.</p>
            {% endif %}
        </form>
        {% if user.is_authenticated %}
        <button id="add_input_box" class="greenBtn" title="목록에 없는 음식을 추가합니다.">음식 추가</button>
        <button type="submit" id="submit_form" class="greenBtn" title="분석 페이지로 넘어갑니다.">완료</button>
        {% else %}
        <h5>운식에 가입하여 정확한 식단 분석을 받아보세요!</h5>
        {% endif %}
    </div>
    <div id="nutrient_information" style="display: none;">
        <h2>영양소 정보</h2>
        <!-- HTML 삽입 -->
    </div>
</aside>

<!-- 마커 만들어주는 스크립트 -->
<script>
    function createMarker(text, x, y, id) {
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.id = 'marker_' + id;
            marker.setAttribute('data-input-id', 'input_' + id);
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.textContent = text;
            marker.addEventListener('click', function() {
                var inputId = marker.getAttribute('data-input-id');
                var inputBox = document.getElementById(inputId);
                inputBox.focus();
            })
            return marker;
        }
    // 이미지 로드
    const img = document.getElementById('meal_image');

    img.onload = function () {
        var width = img.width;
        var height = img.height;

        console.log(width, height)
        
        {% for key, values in detect_results.items %}
        createMarkerAndInput('{{ key }}', {{values.0}}, {{values.1}});
        {% endfor %}

        function createMarkerAndInput(id, tagWidthFactor, tagHeightFactor) {
            var tagWidth = width * tagWidthFactor;
            var tagHeight = height * tagHeightFactor;

            var marker = createMarker(id, tagWidth, tagHeight, id);
            document.getElementById('result_image_box').appendChild(marker);

            var inputBox = document.getElementById('input_' + id);
            inputBox.setAttribute('data-marker-id', 'marker_' + id);
            inputBox.addEventListener('input', function () {
                var markerToUpdateId = inputBox.getAttribute('data-marker-id');
                var markerToUpdate = document.getElementById(markerToUpdateId);
                markerToUpdate.textContent = inputBox.value;
            });
        }
    }
</script>

<!-- ajax 기능 -->
<script>
    $(document).ready(function () {
        $('#submit_form').on('click', function(event) {
            var foodInputs = $(".food-input");

            if (foodInputs.length < 1) {
                event.preventDefault();
                alert("음식을 추가해주세요");
            } else {
                // 음식 이름을 담을 배열 지정
                var foodNames = [];

                $('.food-input').each(function () {
                    var foodId = $(this).attr('name');
                    foodNames.push(foodId);
                });
                // console.log(foodNames)

                $.ajax({
                    type: 'POST',
                    url: '{% url "meal_nutrient" %}', // 페이지 안에 삽입되어 Django 관리 하에 있을 때 사용 가능
                    data: {
                        // form 제출 유효성 검사를 위해 csrf_token 같이 보내기
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'meal_data': JSON.stringify([foodNames, '{{ meal_image }}']),
                    },
                    success: function (data) {
                        const remove_box = $('#modify_result');
                        remove_box.after(data);
                        remove_box.remove();
                    },
                    error: function(error) {
                        alert('서버 오류' + error);
                    }
                });
            };
        });

        $(document).on('input', '.food-input', function(){
            var searchWord = $(this).val();
            // console.log(searchWord)
            var resultContainer = $(this).siblings('.search-results');

            $.ajax({
                url: '{% url "food_search" %}',
                data: {"searchWord": searchWord},
                dataType: 'json',
                success: function(data){
                    // console.log(data)
                    resultContainer.empty();

                    $.each(data.results, function(index, result) {
                        // console.log(result.food_code)
                        var resultItem = $('<li>' + result.name + " | " + result.maker + '</li>');

                        resultItem.click(function() {
                            var currentInput = $(this).closest('.input_container').find('.food-input');
                            currentInput.attr('name', result.food_code);
                            currentInput.val(result.name);
                        });

                        resultContainer.append(resultItem);
                    });
                },
                error: function(error){
                    console.error("알 수 없는 에러 발생", error)
                }
            })
        });
    });
</script>
{% endblock content %}