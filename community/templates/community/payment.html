{% extends 'base.html' %}
{% load static %}
{% block content %}
    <link href="{% static 'css/payment.css' %}" rel="stylesheet">

    <section class="title-explain-section">
        <h4><b>결제 페이지</b></h4>
        <br>
        <h5 style="text-align: left; margin-left: 250px;">나만의 건강 전문가 AI 운식이를 30일 구독하고</h5>
        <h5 style="text-align: left; margin-left: 250px;">건강, 식단, 운동, 질병에 관하여 질문을 하고 답변을 받으세요</h5>
        <br>
        <img src="{% static 'images/unsik_mascot_1.png' %}"> 
        
        <div id="message" style="display: none;"><br><h5>결제에 실패했습니다. 이용이 불가합니다.</h5></div>
    </section>
    <button id="paymentButton" class="paymentButton">결제하기</button>
    <button id="entryButton" style="display: none;">입장하기</button>

    <script src="https://js.bootpay.co.kr/bootpay-4.3.4.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    const userId = "{{ user.id }}";
    const username = "{{ user.username }}";
    const email = "{{ user.email }}";

    const isLocalhost = Boolean(
        window.location.hostname === "localhost" ||
        window.location.hostname === "[::1]" ||
        window.location.hostname.match(
            /^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/
        )
    );

    let apiUrl = ""; // 이 변수에 API 엔드포인트 URL을 설정합니다.
    let newPageUrl = ""; // 이 변수에 페이지 이동 URL을 설정합니다.

    if (isLocalhost) {
        // 로컬 호스트인 경우
        apiUrl = "http://127.0.0.1:8000/fitness_grade/create_point_entry/";
        newPageUrl = "http://127.0.0.1:8000/fitness_grade/llm/";
    } else {
        // 웹 서버인 경우
        apiUrl = "http://18.180.43.72/fitness_grade/create_point_entry/"; // 웹 서버의 실제 API 엔드포인트 URL로 대체해야 합니다.
        newPageUrl = "http://18.180.43.72/fitness_grade/llm/"; // 웹 서버의 실제 페이지 이동 URL로 대체해야 합니다.
    }

    document.getElementById("paymentButton").addEventListener("click", async function () {
        try {
            const response = await Bootpay.requestPayment({
                "application_id": "65bbabd2d25985001eb71530",  // Bootpay에서 발급받은 Application ID
                "price": 1000,
                "order_name": "AI 운식이 챗봇 사용 한달구독",
                "order_id": "TEST_ORDER_ID",
                "pg": "나이스페이먼츠",
                "method": "카드",
                "tax_free": 0,
                "user": {
                    "id": userId,
                    "username": username,
                    "email": email
                },
                "items": [
                    {
                        "id": "item_id",
                        "name": "AI 운식이 챗봇 사용 한달구독",
                        "qty": 1,
                        "price": 1000
                    }
                ],
                "extra": {
                    "open_type": "iframe",
                    "card_quota": "0,2,3",
                    "escrow": false
                }
            })
            switch (response.event) {
                case 'issued':
                    // 가상계좌 입금 완료 처리
                    break
                case 'done':
                    console.log(response)
                    console.log(response.data.status)
                    // 결제 완료 처리
                    if (response.data.status === 1) {  // 결제 성공인 경우
                        const currentDatetime = new Date();
                        const gainedDate = `${currentDatetime.getFullYear()}-${currentDatetime.getMonth() + 1}-${currentDatetime.getDate()} ${currentDatetime.getHours()}:${currentDatetime.getMinutes()}:${currentDatetime.getSeconds()}`;
                        const pointData = {
                            user: userId,
                            point: 1000,  // Adjust the point value as needed
                            gaining_method: "카드 결제",  // Modify as needed
                            gained_date: gainedDate,
                        };

                        $.ajax({
                            type: 'POST',
                            url: "{% url 'create_point_entry' %}", // URL 패턴 이름을 정확하게 지정하세요.
                            data: {
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'payment_user_data': JSON.stringify(pointData),
                            },
                            success: function (data) {
                                console.log("AJAX 요청 성공: ", data); // AJAX 요청 성공 시 로그 출력
                                window.location.href = newPageUrl;  // 페이지 이동은 레코드 생성 후에 수행
                            },
                            error: function (error) {
                                console.error('AJAX 요청 실패: ', error); // AJAX 요청 실패 시 로그 출력
                            }
                        });
                    }
                    break
                case 'confirm': //payload.extra.separately_confirmed = true; 일 경우 승인 전 해당 이벤트가 호출됨
                    console.log(response.receipt_id)

                    // 여기에서 승인 처리 로직 추가
                    const confirmedData = await Bootpay.confirm() //결제를 승인한다
                    if(confirmedData.event === 'done') {
                        //결제 성공
                        console.log(confirmedData)
                    }
                    break
            }
        } catch (e) {
            // 결제 진행중 오류 발생
            // e.error_code - 부트페이 오류 코드
            // e.pg_error_code - PG 오류 코드
            // e.message - 오류 내용
            console.log(e.message)
            switch (e.event) {
                case 'cancel':
                    // 사용자가 결제창을 닫을때 호출
                    console.log(e.message);
                    break
                case 'error':
                    // 결제 승인 중 오류 발생시 호출
                    console.log(e.error_code);
                    // 결제 실패 처리
                    document.getElementById("message").style.display = "block";
                    break
            }
        }
    });
    </script>
{% endblock content %}
