{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="{% static '/css/llm.css' %}">
<script>
    var days_left = {{days_left|safe}};
</script>
<div id="intro" class="intro-container">
        <h4>ì£¼ì œë¥¼ ì„ íƒí•˜ê³  AI ê±´ê°•ê´€ë¦¬ì‚¬ ìš´ì‹ì´ì—ê²Œ ìƒë‹´ë°›ìœ¼ì„¸ìš”.</h4>
        <br>
        <h4>ğŸ‰ğŸŠ"í™˜ì˜í•©ë‹ˆë‹¤~!"ğŸŠğŸ‰</h4>
        <br>
        <h5>êµ¬ë… ì¢…ë£Œê¹Œì§€ {{ days_left }}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤. </h5>
        <br>
        <img src="{% static 'images/unsik_mascot_3.png' %}"> 
        <br>
        <label for="subject">ì–´ë–¤ ì£¼ì œë¥¼ ì—¬ì­™ê³  ì‹¶ì€ê°€ìš”?</label>
        <br>
        <select id="subject" name="subject">
            <option value="ìš´ë™">ìš´ë™</option>
            <option value="ê±´ê°•">ê±´ê°•</option>
            <option value="ì‹ë‹¨">ì‹ë‹¨</option>
            <option value="ì§ˆë³‘">ì§ˆë³‘</option>
        </select>
        <br>
        <button class="startButton" type="button" onclick="start()">AI ê±´ê°•ê´€ë¦¬ì‚¬ ìš´ì‹ì´ì—ê²Œ ìƒë‹´ë°›ê¸°</button>
</div>
{% csrf_token %}
<div id="chat" class="chat-container" style="display: none;">
        <div class="chat-box">
            <div class="chat-message">
                <p class="assistant">ê±´ê°•ê´€ë ¨ ê´€ì‹¬ë¶„ì•¼ì— ëŒ€í•´ ë¬¼ì–´ë´ ì£¼ì„¸ìš”!</p>
            </div>
        </div>
        <div id="loader" class="loader" style="display: none;">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="chat-input">
            <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeydown="if(event.key === 'Enter') document.getElementById('btn').click()">
            <button id="btn" onclick="spinner()">ì „ì†¡</button>
        </div>
</div>
<script>
        const isLocalhost = Boolean(
            window.location.hostname === "localhost" ||
                
                window.location.hostname === "[::1]" ||
                
                window.location.hostname.match(
                /^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/
                )
            );

        let apiUrl = ""; // ì´ ë³€ìˆ˜ì— API ì—”ë“œí¬ì¸íŠ¸ URLì„ ì„¤ì •í•©ë‹ˆë‹¤.

        if (isLocalhost) {
            // ë¡œì»¬ í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš°
            apiUrl = "http://127.0.0.1:8000/fitness_grade/healthcareassistant/";
            } else {
            // ì›¹ ì„œë²„ì¸ ê²½ìš°
            apiUrl = "http://18.180.43.72/fitness_grade/healthcareassistant/"; // ì›¹ ì„œë²„ì˜ ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ URLë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
            }


        const chatBox = document.querySelector('.chat-box');
        let userMessages = [];
        let assistantMessages = [];
        let threadId = '';
        let subject = '';

        function spinner() {
            document.getElementById('loader').style.display = "block";
        }

        function start() {
            subject = document.getElementById('subject').value;

            document.getElementById("intro").style.display = "none";
            document.getElementById("chat").style.display = "block";
        }

        const sendMessage = async () => {
            const chatInput = document.querySelector('.chat-input input');
            const chatMessage = document.createElement('div');
            chatMessage.classList.add('chat-message');
            chatMessage.innerHTML = `
    <p>${chatInput.value}</p>
  `;
            chatBox.appendChild(chatMessage);
            
            //userMessage ë©”ì„¸ì§€ ì¶”ê°€
            userMessage = chatInput.value;

            chatInput.value = '';
            console.log(subject);


            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: subject,
                    userMessage: userMessage,
                    threadId: threadId
                })
            });

            const data = await response.json();
            document.getElementById('loader').style.display = "none";
            
            //assistantMessage ë©”ì„¸ì§€ ì¶”ê°€
            assistantMessages.push(data.assistant);
            threadId = data.threadId;

            const healthcareassistantMessage = document.createElement('div');
            healthcareassistantMessage.classList.add('chat-message');
            healthcareassistantMessage.innerHTML = `
    <p class='assistant'>${data.assistant}</p>
  `;
            chatBox.appendChild(healthcareassistantMessage);
        };

        document.querySelector('.chat-input button').addEventListener('click', sendMessage);
</script>


{% endblock content %}